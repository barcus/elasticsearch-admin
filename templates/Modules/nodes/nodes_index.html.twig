{% extends 'base.html.twig' %}
{% import 'app_import.html.twig' as appImport %}

{% block head_title %}{{ 'nodes'|trans }}{% endblock %}

{% block heading_1 %}
    {{ appImport.heading({'level': 1, 'title': 'nodes'|trans}) }}
{% endblock %}

{% block tabs %}
    {% include 'Modules/nodes/nodes_tabs.html.twig' with {'active': 'list'} %}
{% endblock %}

{% block main_content %}
    {% if 0 < nodes.total %}
        {% embed 'card_embed.html.twig' %}
            {% import 'app_import.html.twig' as appImport %}
            {% block content %}
                {{ appImport.heading({'level': 3, 'title': 'list'|trans, 'badge': nodes.total}) }}

                {{ appImport.paginator(nodes) }}

                {% include 'Modules/nodes/nodes_list.html.twig' with {'nodes': nodes} %}

                {{ appImport.paginator(nodes) }}
            {% endblock %}
        {% endembed %}
    {% endif %}
{% endblock %}

{% block scripts %}
    {{ parent() }}

    <script type="text/javascript">
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    function fetchNodes() {
        console.log('fetchNodes');
        fetch('{{ app.request.schemeAndHttpHost}}{{ app.request.baseUrl }}/admin/nodes/fetch', {
            credentials: 'include',
            method: 'get'
        }).then(function(response) {
            return response.json();
        }).then(async function(json) {
            for(var k in json) {
                $('#' + k + '-uptime').text(json[k]['uptime']);

                $('#' + k + '-os-cpu-percent').text(json[k]['stats']['os']['cpu']['percent']);
                $('#' + k + '-process-cpu-percent').text(json[k]['stats']['process']['cpu']['percent']);

                $('#' + k + '-heap-percent').text(json[k]['heap.percent']);
                $('#' + k + '-heap-current').text(json[k]['heap.current']);
                $('#' + k + '-heap-max').text(json[k]['heap.max']);

                $('#' + k + '-ram-percent').text(json[k]['ram.percent']);
                $('#' + k + '-ram-current').text(json[k]['ram.current']);
                $('#' + k + '-ram-max').text(json[k]['ram.max']);

                $('#' + k + '-disk-used_percent').text(json[k]['disk.used_percent']);
                $('#' + k + '-disk-used').text(json[k]['disk.used']);
                $('#' + k + '-disk-total').text(json[k]['disk.total']);
            }

            await sleep(5000);
            fetchNodes();
        }).catch(function() {
        });
    }
    fetchNodes();
    </script>
{% endblock %}
